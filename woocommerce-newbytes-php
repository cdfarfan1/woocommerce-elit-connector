<?php
/*
Plugin Name: Conector NewBytes
Description: Sincroniza los productos del catálogo de NewBytes con WooCommerce.
Author: NewBytes
Author URI: https://nb.com.ar
Version: 0.1.3
*/

// Prevenir acceso directo al archivo
if (!defined('ABSPATH')) {
    exit;
}

// Definir constantes del plugin
define('NB_PLUGIN_FILE', __FILE__);
define('NB_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('NB_PLUGIN_URL', plugin_dir_url(__FILE__));
define('API_URL_NB', 'https://api.nb.com.ar/v1');
define('VERSION_NB', '0.1.3');

// Función de inicialización principal del plugin
function nb_init() {
    // Verificar que WooCommerce esté instalado y activo
    if (!class_exists('WooCommerce')) {
        add_action('admin_notices', function() {
            echo '<div class="error"><p>El plugin Conector NewBytes requiere que WooCommerce esté instalado y activado.</p></div>';
        });
        return;
    }

    // Incluir archivos necesarios
    $includes = array(
        'utils.php',
        'activation.php',
        'admin-hooks.php',
        'cron-hooks.php',
        'rest-api.php',
        'product-sync.php',
        'product-delete.php',
        'price-calculator.php',
        'modals.php',
        'settings.php',
        'sync-callback.php'
    );

    foreach ($includes as $file) {
        $path = NB_PLUGIN_DIR . 'includes/' . $file;
        if (file_exists($path)) {
            require_once $path;
        }
    }
}

// Inicializar el plugin en el momento correcto
add_action('plugins_loaded', 'nb_init', 20); // Prioridad 20 para asegurar que WooCommerce esté cargado

// Registrar hooks después de la inicialización
function nb_register_hooks() {
    add_action('wp_ajax_nb_update_description_products', 'nb_update_description_products');
    add_action('admin_enqueue_scripts', 'enqueue_fontawesome');
    add_action('wp_ajax_nb_delete_products', 'nb_delete_products');
    add_action('admin_post_nb_delete_products', 'nb_delete_products');
    add_action('update_option_nb_sync_interval', 'nb_update_cron_schedule', 10, 2);
    add_filter('plugin_action_links_' . plugin_basename(NB_PLUGIN_FILE), 'nb_plugin_action_links');
    add_filter('cron_schedules', 'nb_cron_interval');
    add_action('admin_menu', 'nb_menu');
    add_action('admin_init', 'nb_register_settings');
    add_action('nb_cron_sync_event', 'nb_callback');
}
add_action('init', 'nb_register_hooks');

// Registrar hooks de activación/desactivación
register_activation_hook(NB_PLUGIN_FILE, 'nb_activation');
register_deactivation_hook(NB_PLUGIN_FILE, 'nb_deactivation');

// Manejador de errores
function nb_handle_error($errno, $errstr, $errfile, $errline) {
    error_log(sprintf(
        'Error en Conector NewBytes [%d]: %s en %s:%d',
        $errno,
        $errstr,
        $errfile,
        $errline
    ));
    return false;
}
set_error_handler('nb_handle_error');
